show tables;
system echo '[94m-- PART I -------------------------------------------------'
system echo '[94m-----------------------------------------------------------'

-- æ¸…ç†è¡¨ -------------------------------------------------
system echo '[93m==> æ¸…ç†è¡¨';
drop table if exists GOODS;
drop table if exists PLAZA;
drop table if exists SALE;
drop table if exists SALE_CHEAP;
drop table if exists R;
drop view  if exists SALE_CHEAP_VIEW;

-- åˆ›å»ºè¡¨ -------------------------------------------------
system echo '[93m==> åˆ›å»ºè¡¨';
create table if not exists GOODS (
    å•†å“åç§° nvarchar(10) not null primary key,
    å•†å“ç±»å‹ nvarchar(5)  not null
);

create table if not exists PLAZA (
    å•†åœºåç§° nvarchar(10) not null primary key,
    æ‰€åœ¨åœ°åŒº nvarchar(5)  not null
);

create table if not exists SALE (
    å•†å“åç§° nvarchar(10) not null,
    å•†åœºåç§° nvarchar(10) not null,
    ä»·æ ¼     decimal(8,2) not null default 0.0,
    ä¿ƒé”€ç±»å‹ nvarchar(10),
    primary key (å•†å“åç§°, å•†åœºåç§°)
);

-- æ’å…¥æ•°æ® -----------------------------------------------
system echo '[93m==> æ’å…¥æ•°æ®';
insert into GOODS (å•†å“åç§°, å•†å“ç±»å‹) values
('åˆ›ç»´*ç”µè§†',       'ç”µå™¨'),
('æ ¼åŠ›*ç©ºè°ƒ',       'ç”µå™¨'),
('æµ·å°”*å†°ç®±',       'ç”µå™¨'),
('å°å¤©é¹…*æ´—è¡£æœº',   'ç”µå™¨'),
('è€äººå¤´*tæ¤',      'æœè£…'),
('lEE*ç‰›ä»”è£¤',      'æœè£…'),
('å“ˆæ£®*çš®é´',       'æœè£…'),
('ä¸ƒåŒ¹ç‹¼*å¤¹å…‹',     'æœè£…'),
('æ™¨å…‰*ä¸­æ€§ç¬”',     'æ–‡å…·'),
('å¾—åŠ›*ç¬”è®°æœ¬',     'æ–‡å…·'),
('è€å¹²å¦ˆ*è¾£é…±',     'é£Ÿå“'),
('å¥¥åˆ©å¥¥*é¥¼å¹²',     'é£Ÿå“'),
('æµ·å¤©*é…±æ²¹',       'é£Ÿå“');

insert into PLAZA values
('ç¾¤å…‰å¹¿åœº',        'æ­¦æ˜Œ'),
('æ–°ä¸–ç•Œç™¾è´§',      'æ±‰å£'),
('æ±‰å•†è´­ç‰©ä¸­å¿ƒ',    'æ±‰é˜³'),
('å¤§æ´‹ç™¾è´§',        'æ­¦æ˜Œ'),
('æ ¡å›­è¶…å¸‚',        'æ­¦æ˜Œ'),
('ç‹åºœäº•ç™¾è´§',      'æ±‰å£');

insert into SALE values
('åˆ›ç»´*ç”µè§†',       'ç¾¤å…‰å¹¿åœº',     3188,   'æ‰“æŠ˜'  ),
('æ ¼åŠ›*ç©ºè°ƒ',       'ç¾¤å…‰å¹¿åœº',     4588,   'æ‰“æŠ˜'  ),
('æµ·å°”*å†°ç®±',       'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', 3888,   null    ),
('lEE*ç‰›ä»”è£¤',      'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', 500,    'é€åˆ¸'  ),
('æ™¨å…‰*ä¸­æ€§ç¬”',     'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', 1.5,    null    ),
('å¾—åŠ›*ç¬”è®°æœ¬',     'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', 5,      null    ),
('å¥¥åˆ©å¥¥*é¥¼å¹²',     'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', 8,      null    ),
('å°å¤©é¹…*æ´—è¡£æœº',   'å¤§æ´‹ç™¾è´§',     2288,   null    ),
('æ ¼åŠ›*ç©ºè°ƒ',       'å¤§æ´‹ç™¾è´§',     4388,   'æ‰“æŠ˜'  ),
('è€äººå¤´*tæ¤',      'å¤§æ´‹ç™¾è´§',     1200,   'é€åˆ¸'  ),
('lEE*ç‰›ä»”è£¤',      'å¤§æ´‹ç™¾è´§',     380,    'æ‰“æŠ˜'  ),
('å“ˆæ£®*çš®é´',       'å¤§æ´‹ç™¾è´§',     300,    'æ‰“æŠ˜'  ),
('è€å¹²å¦ˆ*è¾£é…±',     'å¤§æ´‹ç™¾è´§',     9,      null    ),
('ä¸ƒåŒ¹ç‹¼*å¤¹å…‹',     'æ–°ä¸–ç•Œç™¾è´§',   880,    'æ‰“æŠ˜'  ),
('æ™¨å…‰*ä¸­æ€§ç¬”',     'æ ¡å›­è¶…å¸‚',     1,      null    ),
('å¾—åŠ›*ç¬”è®°æœ¬',     'æ ¡å›­è¶…å¸‚',     4.5,    null    ),
('å¥¥åˆ©å¥¥*é¥¼å¹²',     'æ ¡å›­è¶…å¸‚',     8.5,    null    );

system echo '[94m-- PART II ------------------------------------------------'
system echo '[94m-----------------------------------------------------------'
-- å°†SALEè¡¨ä¸­æ´»åŠ¨ç±»å‹ä¸ºæ‰“æŠ˜çš„è®°å½•æ’å…¥åˆ°æ–°è¡¨SALE_CHEAPä¸­ ---
system echo '[93m==> å°†SALEè¡¨ä¸­æ´»åŠ¨ç±»å‹ä¸ºæ‰“æŠ˜çš„è®°å½•æ’å…¥åˆ°æ–°è¡¨SALE_CHEAPä¸­';
create table if not exists SALE_CHEAP as (
    select * from SALE
    where ä¿ƒé”€ç±»å‹="æ‰“æŠ˜"
);
select * from SALE_CHEAP;

-- ç¾¤å…‰å¹¿åœºçš„åˆ›ç»´ç”µè§†åœæ­¢æ‰“æŠ˜æ´»åŠ¨ï¼Œä»·æ ¼æ¢å¤ä¸º3988 ---------
system echo '[93m==> ç¾¤å…‰å¹¿åœºçš„åˆ›ç»´ç”µè§†åœæ­¢æ‰“æŠ˜æ´»åŠ¨ï¼Œä»·æ ¼æ¢å¤ä¸º3988';
update SALE
set ä»·æ ¼=3988, ä¿ƒé”€ç±»å‹=null
where å•†åœºåç§°='ç¾¤å…‰å¹¿åœº' and å•†å“åç§°='åˆ›ç»´*ç”µè§†';

delete from SALE_CHEAP
where å•†åœºåç§°='ç¾¤å…‰å¹¿åœº' and å•†å“åç§°='åˆ›ç»´*ç”µè§†';

select * from SALE;
select * from SALE_CHEAP;

-- åŸºäºSALE_CHEAPè¡¨åˆ›å»ºä¸€ä¸ªç»Ÿè®¡æ¯ä¸ªæ‰“æŠ˜å•†å“å¹³å‡ä»·æ ¼çš„è§†å›¾--
system echo '[93m==> åŸºäºSALE_CHEAPè¡¨åˆ›å»ºä¸€ä¸ªç»Ÿè®¡æ¯ä¸ªæ‰“æŠ˜å•†å“å¹³å‡ä»·æ ¼çš„è§†å›¾';
create view if not exists SALE_VIEW as (
    select å•†å“åç§°, AVG(ä»·æ ¼)
    from SALE_CHEAP
    group by å•†å“åç§°
);
select * from SALE_VIEW;

system echo '[94m-- PART III -----------------------------------------------'
system echo '[94m-----------------------------------------------------------'
-- æŸ¥è¯¢æœ‰æ²¡æœ‰ä»»ä½•ä¿ƒé”€æ´»åŠ¨çš„å•†å“åŠå…¶æ‰€åœ¨çš„å•†åœº -------------
system echo '[93m==> æŸ¥è¯¢æœ‰æ²¡æœ‰ä»»ä½•ä¿ƒé”€æ´»åŠ¨çš„å•†å“åŠå…¶æ‰€åœ¨çš„å•†åœº';
select å•†å“åç§°, å•†åœºåç§°
from SALE
where ä¿ƒé”€ç±»å‹ is null
order by å•†å“åç§°;

-- æŸ¥è¯¢ä»·æ ¼åœ¨200ï½500å…ƒä¹‹é—´çš„å•†å“åç§°ç­‰ -------------------
system echo '[93m==> æŸ¥è¯¢ä»·æ ¼åœ¨200ï½500å…ƒä¹‹é—´çš„å•†å“åç§°ç­‰';
select å•†å“åç§°, å•†åœºåç§°, ä»·æ ¼
from SALE
where ä»·æ ¼>=200 and ä»·æ ¼<=500
order by å•†åœºåç§°;

-- æŸ¥è¯¢æ¯ç§å•†å“çš„å•†å“åç§°ã€æœ€ä½å”®ä»·ã€æœ€é«˜å”®ä»· -------------
system echo '[93m==> æŸ¥è¯¢æ¯ç§å•†å“çš„å•†å“åç§°ã€æœ€ä½å”®ä»·ã€æœ€é«˜å”®ä»·';
select  å•†å“ç±»å‹, min(ä»·æ ¼), max(ä»·æ ¼)
from GOODS join SALE
on GOODS.å•†å“åç§°=SALE.å•†å“åç§°
group by å•†å“ç±»å‹;

-- æŸ¥è¯¢ä»¥â€œæ‰“æŠ˜â€æ–¹å¼é”€å”®çš„å•†å“æ€»æ•°è¶…è¿‡2ç§çš„å•†åœºä¿¡æ¯ --------
system echo '[93m==> æŸ¥è¯¢ä»¥â€œæ‰“æŠ˜â€æ–¹å¼é”€å”®çš„å•†å“æ€»æ•°è¶…è¿‡2ç§çš„å•†åœºä¿¡æ¯';
select PLAZA.å•†åœºåç§°, PLAZA.æ‰€åœ¨åœ°åŒº
from PLAZA join SALE
on PLAZA.å•†åœºåç§°=SALE.å•†åœºåç§°
where ä¿ƒé”€ç±»å‹='æ‰“æŠ˜'
group by PLAZA.å•†åœºåç§°
having count(*)>2;

-- æŸ¥è¯¢ä»¥â€œè€â€å­—å¼€å¤´çš„æ‰€æœ‰å•†å“çš„åç§° -----------------------
system echo '[93m==> æŸ¥è¯¢ä»¥â€œè€â€å­—å¼€å¤´çš„æ‰€æœ‰å•†å“çš„åç§°';
select å•†å“åç§°
from GOODS
where å•†å“åç§° like 'è€%';

-- æŸ¥è¯¢åŒæ—¶é”€å”®â€œæ™¨å…‰*ä¸­æ€§ç¬”â€å’Œâ€œå¾—åŠ›*ç¬”è®°æœ¬â€çš„å•†åœºåç§° -----
system echo '[93m==> æŸ¥è¯¢åŒæ—¶é”€å”®â€œæ™¨å…‰*ä¸­æ€§ç¬”â€å’Œâ€œå¾—åŠ›*ç¬”è®°æœ¬â€çš„å•†åœºåç§°';
( select å•†åœºåç§°
from SALE
where å•†å“åç§°='æ™¨å…‰*ä¸­æ€§ç¬”'
) intersect ( select å•†åœºåç§°
from SALE
where å•†å“åç§°='å¾—åŠ›*ç¬”è®°æœ¬'
);

-- æŸ¥è¯¢æœªä¸¾åŠä»»ä½•æ´»åŠ¨çš„å•†åœº -------------------------------
system echo '[93m==> æŸ¥è¯¢æœªä¸¾åŠä»»ä½•æ´»åŠ¨çš„å•†åœº';
select å•†åœºåç§°
from SALE
group by å•†åœºåç§°
having COUNT(ä¿ƒé”€ç±»å‹) = 0;

-- æŸ¥è¯¢å‡ºå”®å•†å“ç§ç±»æœ€å¤šçš„å•†åœºåç§° -------------------------
system echo '[93m==> æŸ¥è¯¢å‡ºå”®å•†å“ç§ç±»æœ€å¤šçš„å•†åœºåç§°';
select å•†åœºåç§°
from SALE
group by å•†åœºåç§°
having count(*)>=all(
    select count(*)
    from SALE
    group by å•†åœºåç§°
);

-- æŸ¥è¯¢å‡ºå”®å•†å“ç±»å‹æœ€å¤šçš„å•†åœºåç§° -------------------------
system echo '[93m==> æŸ¥è¯¢å‡ºå”®å•†å“ç±»å‹æœ€å¤šçš„å•†åœºåç§°';
select å•†åœºåç§°
from
SALE inner join GOODS
on SALE.å•†å“åç§°=GOODS.å•†å“åç§°
group by SALE.å•†åœºåç§°
having count(distinct GOODS.å•†å“ç±»å‹)>=all(
    select count(distinct GOODS.å•†å“ç±»å‹)
    from SALE inner join GOODS
    on SALE.å•†å“åç§°=GOODS.å•†å“åç§°
    group by SALE.å•†åœºåç§°
);

-- æŸ¥è¯¢é”€å”®å•†å“åŒ…å«â€œæ ¡å›­è¶…å¸‚â€æ‰€é”€å”®çš„æ‰€æœ‰å•†å“çš„å•†åœºåç§° ---
system echo '[93m==> æŸ¥è¯¢é”€å”®å•†å“åŒ…å«â€œæ ¡å›­è¶…å¸‚â€æ‰€é”€å”®çš„æ‰€æœ‰å•†å“çš„å•†åœºåç§°';
select oldSALE.å•†åœºåç§°
from (
    select * from SALE
) as oldSALE
inner join (
    select å•†å“åç§° from SALE
    where å•†åœºåç§°='æ ¡å›­è¶…å¸‚'
) as newSALE
on oldSALE.å•†å“åç§°=newSALE.å•†å“åç§°
group by oldSALE.å•†åœºåç§°
having
    count(distinct oldSALE.å•†å“åç§°)=count(distinct newSALE.å•†å“åç§°);

-- æŸ¥è¯¢æ‰€æœ‰å•†å“çš„åç§°åŠå‡ºå”®è¯¥å•†å“çš„å•†åœº -------------------

system echo '[93m==> æŸ¥è¯¢æ‰€æœ‰å•†å“çš„åç§°åŠå‡ºå”®è¯¥å•†å“çš„å•†åœºï¼Œæ˜¾ç¤ºæœªåœ¨ä»»ä½•å•†åœºå‡ºå”®çš„å•†å“åç§°';
select GOODS.å•†å“åç§°, å•†åœºåç§°
from GOODS left outer join SALE
on GOODS.å•†å“åç§° = SALE.å•†å“åç§°;


system echo '[94m-- PART IV ------------------------------------------------'
system echo '[94m-----------------------------------------------------------'
-- åœ¨SALEä¸­å¢åŠ æ´»åŠ¨æˆªæ­¢æ—¶é—´åˆ—ï¼Œ å¹¶è¿›è¡Œå„ç§æŸ¥è¯¢ ------------
system echo '[93m==> åœ¨SALEä¸­å¢åŠ æ´»åŠ¨æˆªæ­¢æ—¶é—´åˆ—ï¼Œ å¹¶è¿›è¡Œå„ç§æŸ¥è¯¢'
system echo '[33m--> åœ¨SALEè¡¨ä¸­å¢åŠ ä¸€ä¸ªæ´»åŠ¨æˆªæ­¢æ—¶é—´åˆ—';
alter table SALE
add æ´»åŠ¨æˆªæ­¢æ—¶é—´ timestamp;

insert into SALE (å•†å“åç§°,å•†åœºåç§°,æ´»åŠ¨æˆªæ­¢æ—¶é—´)
values
('åˆ›ç»´*ç”µè§†',       'ç¾¤å…‰å¹¿åœº',     '2019-03-31 04:23:21'),
('æ ¼åŠ›*ç©ºè°ƒ',       'ç¾¤å…‰å¹¿åœº',     '2016-09-12 01:36:41'),
('æµ·å°”*å†°ç®±',       'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', '2018-05-31 23:50:01'),
('lEE*ç‰›ä»”è£¤',      'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', '2018-05-31 01:43:21'),
('æ™¨å…‰*ä¸­æ€§ç¬”',     'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', '2019-05-26 01:00:00'),
('å¾—åŠ›*ç¬”è®°æœ¬',     'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', '2018-10-01 03:06:41'),
('å¥¥åˆ©å¥¥*é¥¼å¹²',     'æ±‰å•†è´­ç‰©ä¸­å¿ƒ', '2018-07-19 08:00:00'),
('å°å¤©é¹…*æ´—è¡£æœº',   'å¤§æ´‹ç™¾è´§',     '2018-10-26 17:00:00'),
('æ ¼åŠ›*ç©ºè°ƒ',       'å¤§æ´‹ç™¾è´§',     '2016-10-08 12:00:00'),
('è€äººå¤´*tæ¤',      'å¤§æ´‹ç™¾è´§',     '2018-11-19 05:00:00'),
('lEE*ç‰›ä»”è£¤',      'å¤§æ´‹ç™¾è´§',     '2016-12-14 12:23:21'),
('å“ˆæ£®*çš®é´',       'å¤§æ´‹ç™¾è´§',     '2018-05-22 22:30:01'),
('è€å¹²å¦ˆ*è¾£é…±',     'å¤§æ´‹ç™¾è´§',     '2016-12-26 08:50:01'),
('ä¸ƒåŒ¹ç‹¼*å¤¹å…‹',     'æ–°ä¸–ç•Œç™¾è´§',   '2018-05-16 15:23:21'),
('æ™¨å…‰*ä¸­æ€§ç¬”',     'æ ¡å›­è¶…å¸‚',     '2019-12-14 06:00:00'),
('å¾—åŠ›*ç¬”è®°æœ¬',     'æ ¡å›­è¶…å¸‚',     '2016-02-04 18:00:00'),
('å¥¥åˆ©å¥¥*é¥¼å¹²',     'æ ¡å›­è¶…å¸‚',     '2016-08-25 03:06:41')
on duplicate key update æ´»åŠ¨æˆªæ­¢æ—¶é—´=values(æ´»åŠ¨æˆªæ­¢æ—¶é—´);

system echo '[33m--> æŸ¥å‡ºæ‰€æœ‰åœ¨æ•´ç‚¹æ—¶åˆ»æˆªæ­¢æ´»åŠ¨çš„å•†å“';
select * from SALE
where minute(æ´»åŠ¨æˆªæ­¢æ—¶é—´)=0 and second(æ´»åŠ¨æˆªæ­¢æ—¶é—´)=0;

system echo '[33m--> æŸ¥è¯¢æ´»åŠ¨æˆªæ­¢æ—¶é—´åœ¨æœ¬æœˆæœ€åä¸€å¤©çš„SALEè®°å½•';
select *
from SALE
where date(æ´»åŠ¨æˆªæ­¢æ—¶é—´)=last_day(curdate());

system echo '[33m--> æŸ¥è¯¢æ´»åŠ¨æˆªæ­¢æ—¶é—´åœ¨2016å¹´çš„SALEè®°å½•';
select *
from SALE
where year(æ´»åŠ¨æˆªæ­¢æ—¶é—´)=2016;

system echo '[33m--> æŸ¥è¯¢æœ¬æœˆçš„æœ€åä¸€å¤©';
select last_day(curdate());

system echo '[33m--> å°†æ‰€æœ‰æ‰“æŠ˜å•†å“çš„æ´»åŠ¨æˆªæ­¢æ—¶é—´æ¨è¿Ÿä¸€ä¸ªå°æ—¶';
update SALE
set `æ´»åŠ¨æˆªæ­¢æ—¶é—´`=timestampadd(hour, 1, `æ´»åŠ¨æˆªæ­¢æ—¶é—´`);
select * from SALE;

-- å°†æŸ¥è¯¢ç»“æœçš„æŸäº›åˆ—çš„æŸäº›å€¼è½¬æ¢æˆç‰¹æ®Šçš„å½¢å¼ -------------
system echo '[93m==> å°†æŸ¥è¯¢ç»“æœçš„æŸäº›åˆ—çš„æŸäº›å€¼è½¬æ¢æˆç‰¹æ®Šçš„å½¢å¼';
select å•†åœºåç§°,
case æ‰€åœ¨åœ°åŒº
    when 'æ­¦æ˜Œ' then 'é™„è¿‘'
    else 'é¥è¿œ'
end as 'æ‰€åœ¨åœ°åŒº'
from PLAZA;

-- æŸ¥è¯¢ä»·æ ¼ä¸ªä½æ•°ä¸º8å…ƒçš„å•†å“åç§°ã€æ‰€åœ¨å•†åœºåç§°å’Œä»·æ ¼ ------
system echo '[93m==> æŸ¥è¯¢ä»·æ ¼ä¸ªä½æ•°ä¸º8å…ƒçš„å•†å“åç§°ã€æ‰€åœ¨å•†åœºåç§°å’Œä»·æ ¼';
select å•†å“åç§°, å•†åœºåç§°, ä»·æ ¼
from SALE
where ä»·æ ¼%10=8;

-- å‡è®¾å“ç‰Œåä¸å¯èƒ½åŒ…å«â€œ*â€å·ï¼ŒæŸ¥è¯¢æ‰€æœ‰å•†å“çš„å“ ------------
system echo '[93m==> å‡è®¾å“ç‰Œåä¸å¯èƒ½åŒ…å«â€œ*â€å·ï¼ŒæŸ¥è¯¢æ‰€æœ‰å•†å“çš„å“';
select å•†å“åç§°,substr(å•†å“åç§°, 1, instr(å•†å“åç§°, '*') - 1) as å“ç‰Œå
from SALE;

system echo '[94m-- PART V -------------------------------------------------'
system echo '[94m-----------------------------------------------------------'
create table if not exists R (
    A char(10) primary key,
    B int
);

insert into R values
("C1", 40),
("C2", 50),
("C3", 60);
